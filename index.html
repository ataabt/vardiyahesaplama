<!DOCTYPE html>
<html lang="tr">
<head>
    <title>Akıllı Vardiya Takvimi</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary-bg: #f4f6f9;
            --card-bg: #ffffff;
            
            /* Vardiya Renkleri */
            --v1-color: #2c3e50; --v1-bg: #eceff1;
            --v2-color: #f57f17; --v2-bg: #fff3e0;
            --v3-color: #c62828; --v3-bg: #ffebee;
            --tatil-color: #7b1fa2; --tatil-bg: #f3e5f5;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--primary-bg);
            padding-bottom: 50px;
        }
        
        .main-card {
            border: none; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden; background: var(--card-bg);
        }

        .header-area {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            padding: 20px; color: white; text-align: center;
        }

        /* --- MENÜ SEKMELERİ --- */
        .nav-pills {
            flex-wrap: nowrap !important;
            overflow-x: auto;
            gap: 5px;
            scrollbar-width: none; /* Firefox */
        }
        .nav-pills::-webkit-scrollbar { display: none; } /* Chrome/Safari */
        
        .nav-link {
            white-space: nowrap;
            padding: 10px 15px !important;
            font-size: 0.9rem;
            color: #555;
            background: #f8f9fa;
            border-radius: 10px !important;
            margin-bottom: 5px;
        }
        .nav-link.active {
            background-color: #0d47a1 !important;
            color: white !important;
            box-shadow: 0 4px 10px rgba(13, 71, 161, 0.3);
        }

        /* --- VARDİYA SEÇİM KUTULARI --- */
        .shift-selector { display: none; }
        .shift-option {
            border: 2px solid #e0e0e0; border-radius: 12px; padding: 10px;
            text-align: center; cursor: pointer; transition: all 0.2s; background: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; min-height: 100px;
        }
        .shift-option i { font-size: 1.8rem; margin-bottom: 5px; display: block; line-height: 1; }
        .shift-option div { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
        .shift-option small { font-size: 0.75rem; color: #777; font-weight: 500; }

        .shift-selector:checked + .shift-option.opt-v1 { border-color: var(--v1-color); background-color: var(--v1-bg); color: var(--v1-color); }
        .shift-selector:checked + .shift-option.opt-v2 { border-color: var(--v2-color); background-color: var(--v2-bg); color: var(--v2-color); }
        .shift-selector:checked + .shift-option.opt-v3 { border-color: var(--v3-color); background-color: var(--v3-bg); color: var(--v3-color); }

        /* --- TAKVİM TASARIMI --- */
        .calendar-wrapper { padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #eee; margin-bottom: 20px; page-break-inside: avoid; }
        .calendar-header { text-align: center; font-weight: 800; font-size: 1.2rem; margin-bottom: 15px; color: #333; text-transform: uppercase; letter-spacing: 1px; }
        
        .calendar-table { width: 100%; border-collapse: separate; border-spacing: 3px; table-layout: fixed; }
        .calendar-table th { text-align: center; font-size: 0.75rem; color: #888; padding-bottom: 8px; text-transform: uppercase; }
        .calendar-table td {
            height: 65px; vertical-align: top; border: 1px solid #f1f1f1; border-radius: 8px; background: #fff;
            position: relative;
        }
        .cal-cell-inner { height: 100%; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 4px; }
        .day-num { font-weight: 700; font-size: 0.9rem; color: #444; }
        .cal-badge { 
            font-size: 0.65rem; font-weight: 800; padding: 3px 2px; border-radius: 5px; width: 100%; text-align: center;
            display: flex; justify-content: center; align-items: center; gap: 3px; line-height: 1.2;
        }
        .today-border { border: 2px solid #0d47a1 !important; box-shadow: 0 0 10px rgba(13, 71, 161, 0.1); }
        
        /* Renk Sınıfları */
        .c-v1 { background: var(--v1-bg); color: var(--v1-color); }
        .c-v2 { background: var(--v2-bg); color: var(--v2-color); }
        .c-v3 { background: var(--v3-bg); color: var(--v3-color); }
        .c-tatil { background: var(--tatil-bg); color: var(--tatil-color); }

        /* --- GÜN SORGULA KARTI --- */
        .big-result-card {
            background: white; border-radius: 16px; padding: 30px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); border-top: 8px solid #ccc; margin-top: 20px;
        }
        .big-date { font-size: 1.4rem; font-weight: 800; margin-bottom: 5px; color: #333; }
        .big-dayname { font-size: 1.1rem; color: #666; margin-bottom: 25px; }
        .big-icon { font-size: 3.5rem; margin-bottom: 15px; }
        .big-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; }
        .big-time { font-size: 0.9rem; background: #f0f0f0; display: inline-block; padding: 6px 15px; border-radius: 20px; font-weight: 600; color: #555; }

        /* --- MOBİL İÇİN ÖZEL AYARLAR (GÜNCELLENDİ) --- */
        @media (max-width: 576px) {
            .nav-link { font-size: 0.8rem; padding: 8px 10px !important; }
            .calendar-table td { height: 60px; } /* Yüksekliği biraz azalttık */
            .day-num { font-size: 0.8rem; margin-bottom: 2px; }
            
            .cal-badge { 
                font-size: 0.55rem; 
                flex-direction: column; /* İkon ve yazıyı alt alta diz */
                padding: 2px 1px;
                gap: 1px;
            }
            .cal-badge i { 
                display: block !important; /* İKONLARI GÖSTER */
                font-size: 1rem; /* İkon boyutu */
            } 
        }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="main-card">
                
                <div class="header-area">
                    <h4 class="m-0 fw-bold"><i class="bi bi-calendar-range me-2"></i>Vardiya Takvimi</h4>
                </div>

                <div class="card-body p-3 p-md-4">
                    
                    <div class="bg-light p-3 rounded-4 mb-4 border">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="small fw-bold text-muted text-uppercase mb-1">Başlangıç Tarihi</label>
                                <input type="date" class="form-control" id="baslangic_tarihi">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-muted text-uppercase mb-1">Tatil Günü</label>
                                <select class="form-select" id="tatil_gunu">
                                    <option value="1">Pazartesi</option>
                                    <option value="2">Salı</option>
                                    <option value="3">Çarşamba</option>
                                    <option value="4">Perşembe</option>
                                    <option value="5">Cuma</option>
                                    <option value="6">Cumartesi</option>
                                    <option value="0" selected>Pazar</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="small fw-bold text-muted text-uppercase mb-2">Başlangıç Vardiyası</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <input type="radio" name="startVardiya" id="sv1" value="1" class="shift-selector" checked>
                                        <label for="sv1" class="shift-option opt-v1">
                                            <i class="bi bi-moon-stars-fill"></i><div>Gece</div><small>24/08</small>
                                        </label>
                                    </div>
                                    <div class="col-4">
                                        <input type="radio" name="startVardiya" id="sv2" value="2" class="shift-selector">
                                        <label for="sv2" class="shift-option opt-v2">
                                            <i class="bi bi-brightness-high-fill"></i><div>Gündüz</div><small>08/16</small>
                                        </label>
                                    </div>
                                    <div class="col-4">
                                        <input type="radio" name="startVardiya" id="sv3" value="3" class="shift-selector">
                                        <label for="sv3" class="shift-option opt-v3">
                                            <i class="bi bi-lock-fill"></i><div>Kilit</div><small>16/24</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold" id="pills-query-tab" data-bs-toggle="pill" data-bs-target="#pills-query">
                                <i class="bi bi-search me-1"></i>Gün Sorgula
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" id="pills-calendar-tab" data-bs-toggle="pill" data-bs-target="#pills-calendar">
                                <i class="bi bi-grid-3x3 me-1"></i>Tek Ay
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" id="pills-range-tab" data-bs-toggle="pill" data-bs-target="#pills-range">
                                <i class="bi bi-calendar-week me-1"></i>Çoklu Ay
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        
                        <div class="tab-pane fade show active" id="pills-query">
                            <div class="input-group mb-3">
                                <input type="date" id="query_date" class="form-control form-control-lg">
                                <button class="btn btn-primary btn-lg px-4" onclick="checkSingleDay()">HESAPLA</button>
                            </div>
                            <div id="query-result-area" style="display:none;"></div>
                        </div>

                        <div class="tab-pane fade" id="pills-calendar">
                            <div class="d-flex gap-2 mb-3">
                                <input type="month" id="takvim_ay" class="form-control form-control-lg">
                                <button class="btn btn-primary px-4" onclick="renderSingleCalendar()"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                            
                            <div id="export-single-calendar-area">
                                <div id="single-calendar-container"></div>
                            </div>

                            <button class="btn btn-dark w-100 mt-3 py-2" onclick="exportPDF('export-single-calendar-area', 'Aylik_Takvim')">
                                <i class="bi bi-file-earmark-pdf-fill me-2"></i>PDF Olarak İndir
                            </button>
                        </div>

                        <div class="tab-pane fade" id="pills-range">
                            <div class="row g-2 mb-3">
                                <div class="col-5">
                                    <label class="small text-muted fw-bold">Başlangıç</label>
                                    <input type="date" id="range_start" class="form-control">
                                </div>
                                <div class="col-5">
                                    <label class="small text-muted fw-bold">Bitiş</label>
                                    <input type="date" id="range_end" class="form-control">
                                </div>
                                <div class="col-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="renderRangeCalendars()"><i class="bi bi-search"></i></button>
                                </div>
                            </div>

                            <div id="export-range-area" class="bg-white p-1">
                                <div id="range-calendar-container"></div>
                            </div>

                            <button class="btn btn-dark w-100 mt-3 py-2" onclick="exportPDF('export-range-area', 'Yillik_Takvim')">
                                <i class="bi bi-file-earmark-pdf-fill me-2"></i>PDF Olarak İndir
                            </button>
                        </div>

                    </div>
                </div>
            </div>
            <div class="text-center text-muted mt-3 small">
                <i class="bi bi-info-circle me-1"></i>Ayarlarınız tarayıcıda otomatik kaydedilir.
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // --- VERİLER ---
    const gunler = ["Pazar", "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi"];
    const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

    const shiftData = {
        1: { icon: "bi-moon-stars-fill", label: "Gece Vardiyası", time: "24:00 - 08:00", short: "Gece", color: "#2c3e50", bg: "#eceff1", cal: "c-v1" },
        2: { icon: "bi-brightness-high-fill", label: "Gündüz Vardiyası", time: "08:00 - 16:00", short: "Gündüz", color: "#f57f17", bg: "#fff3e0", cal: "c-v2" },
        3: { icon: "bi-lock-fill", label: "Kilit Vardiyası", time: "16:00 - 24:00", short: "Kilit", color: "#c62828", bg: "#ffebee", cal: "c-v3" }
    };

    // --- BAŞLANGIÇ AYARLARI ---
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        
        // Inputlara bugünün tarihini ata
        document.getElementById('baslangic_tarihi').value = today;
        document.getElementById('query_date').value = today;
        document.getElementById('takvim_ay').value = today.slice(0, 7);
        document.getElementById('range_start').value = today;
        
        // Çoklu seçim bitiş tarihi (2 ay sonrası)
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 2);
        document.getElementById('range_end').value = nextMonth.toISOString().split('T')[0];

        loadSettings();
    };

    function loadSettings() {
        if(localStorage.getItem('my_vardiya')) {
            const el = document.querySelector(`input[name="startVardiya"][value="${localStorage.getItem('my_vardiya')}"]`);
            if(el) el.checked = true;
        }
        if(localStorage.getItem('my_tatil')) document.getElementById('tatil_gunu').value = localStorage.getItem('my_tatil');
        if(localStorage.getItem('my_baslangic')) document.getElementById('baslangic_tarihi').value = localStorage.getItem('my_baslangic');
    }

    function saveSettings() {
        localStorage.setItem('my_vardiya', document.querySelector('input[name="startVardiya"]:checked').value);
        localStorage.setItem('my_tatil', document.getElementById('tatil_gunu').value);
        localStorage.setItem('my_baslangic', document.getElementById('baslangic_tarihi').value);
    }

    // --- HESAPLAMA MOTORU (DÜZELTİLDİ) ---
    function getShiftForDate(targetDateStr) {
        const baslangicStr = document.getElementById('baslangic_tarihi').value;
        if(!baslangicStr) return { error: true };

        const baslangicTarihi = new Date(baslangicStr);
        const baslangicVardiya = parseInt(document.querySelector('input[name="startVardiya"]:checked').value);
        const tatilGunu = parseInt(document.getElementById('tatil_gunu').value);
        const hedefTarih = new Date(targetDateStr);

        // Saat farklarını yok saymak için saati sabitle
        baslangicTarihi.setHours(12,0,0,0);
        hedefTarih.setHours(12,0,0,0);

        if (hedefTarih < baslangicTarihi) return { error: true, msg: "Başlangıçtan önceki tarih" };

        const nextShift = { 1: 3, 2: 1, 3: 2 }; // V1 -> V3 -> V2 döngüsü
        let currentVar = baslangicVardiya;
        let pendingChange = false;
        
        let cursor = new Date(baslangicTarihi);
        let safety = 0;
        
        while (cursor <= hedefTarih && safety < 10000) {
            const dayOfWeek = cursor.getDay();
            
            // ÖNCE DEĞİŞİKLİK KONTROLÜ (DÜZELTME BURADA YAPILDI)
            // Eğer dün tatildi ise (pendingChange=true) ve bugün tatil değilse,
            // bugünün vardiyasını hesaplamadan ÖNCE değiştir.
            if (pendingChange && dayOfWeek !== tatilGunu) {
                currentVar = nextShift[currentVar];
                pendingChange = false;
            }

            // SONRA HEDEF KONTROLÜ
            if (cursor.getTime() === hedefTarih.getTime()) {
                if (dayOfWeek === tatilGunu) return { tatil: true };
                return { vardiya: currentVar };
            }
            
            // Eğer bugün tatilse, sonraki iş günü için değişim bayrağını kaldır
            if (dayOfWeek === tatilGunu) {
                pendingChange = true;
            }
            
            cursor.setDate(cursor.getDate() + 1);
            safety++;
        }
        return { error: true };
    }

    // --- 1. GÜN SORGULA ---
    function checkSingleDay() {
        saveSettings();
        const dateVal = document.getElementById('query_date').value;
        if(!dateVal) return;
        
        const result = getShiftForDate(dateVal);
        const div = document.getElementById('query-result-area');
        const d = new Date(dateVal);
        
        let html = '';
        if(result.error) {
            html = `<div class="alert alert-warning text-center mt-3"><i class="bi bi-exclamation-triangle me-2"></i>Lütfen "Başlangıç Tarihi"nden sonraki bir tarihi seçin.</div>`;
        } else if(result.tatil) {
            html = createBigCard(d, "HAFTALIK TATİL", "bi-emoji-sunglasses-fill", "Dinlenme Zamanı", "#7b1fa2", "#f3e5f5");
        } else {
            const s = shiftData[result.vardiya];
            html = createBigCard(d, s.label, s.icon, s.time, s.color, s.bg);
        }
        div.innerHTML = html;
        div.style.display = 'block';
    }

    function createBigCard(dateObj, title, icon, subtitle, color, bg) {
        const gunIsim = gunler[dateObj.getDay()];
        const tamTarih = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        
        return `
        <div class="big-result-card" style="border-top-color: ${color};">
            <div class="big-date">${tamTarih}</div>
            <div class="big-dayname">${gunIsim}</div>
            <div class="big-icon" style="color: ${color};"><i class="bi ${icon}"></i></div>
            <div class="big-title" style="color: ${color};">${title}</div>
            ${subtitle ? `<div class="big-time">${subtitle}</div>` : ''}
        </div>`;
    }

    // --- 2. TEK AYLIK TAKVİM ---
    function renderSingleCalendar() {
        saveSettings();
        const ayDegeri = document.getElementById('takvim_ay').value;
        if (!ayDegeri) return;
        
        const [yil, ay] = ayDegeri.split('-');
        const html = buildCalendarHTML(parseInt(yil), parseInt(ay));
        document.getElementById('single-calendar-container').innerHTML = html;
    }

    // --- 3. ÇOKLU TAKVİM ---
    function renderRangeCalendars() {
        saveSettings();
        const startStr = document.getElementById('range_start').value;
        const endStr = document.getElementById('range_end').value;
        
        if(!startStr || !endStr) return;

        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        
        // Başlangıç ayının 1'ine git
        let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
        const finalMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
        
        let fullHTML = "";
        let safety = 0;

        while (currentMonth <= finalMonth && safety < 36) { // Max 3 yıl
            fullHTML += buildCalendarHTML(currentMonth.getFullYear(), currentMonth.getMonth() + 1);
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            safety++;
        }
        
        document.getElementById('range-calendar-container').innerHTML = fullHTML;
    }

    // --- ORTAK HTML OLUŞTURUCU ---
    function buildCalendarHTML(year, month) {
        const monthName = aylar[month - 1];
        const firstDayDate = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0).getDate();
        
        // Haftanın başlangıcı (Pazartesi=1 yapmak için)
        let startDay = firstDayDate.getDay(); 
        if (startDay === 0) startDay = 7; // Pazar'ı 7 yap

        let html = `<div class="calendar-wrapper">
            <div class="calendar-header">${monthName} ${year}</div>
            <table class="calendar-table">
                <thead>
                    <tr><th>Pzt</th><th>Sal</th><th>Çar</th><th>Per</th><th>Cum</th><th>Cmt</th><th>Paz</th></tr>
                </thead>
                <tbody><tr>`;

        // Boş günleri doldur
        for (let i = 1; i < startDay; i++) {
            html += '<td style="background:#f9f9f9; border:none;"></td>';
        }

        const todayStr = new Date().toISOString().split('T')[0];
        
        for (let day = 1; day <= lastDay; day++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const result = getShiftForDate(dateStr);
            const isToday = (todayStr === dateStr) ? 'today-border' : '';
            
            let content = '';
            if (!result.error) {
                if (result.tatil) {
                    content = `<div class="cal-badge c-tatil">TATİL</div>`;
                } else {
                    const s = shiftData[result.vardiya];
                    content = `<div class="cal-badge ${s.cal}"><i class="bi ${s.icon}"></i>${s.short}</div>`;
                }
            }

            html += `<td class="${isToday}">
                <div class="cal-cell-inner">
                    <span class="day-num">${day}</span>
                    ${content}
                </div>
            </td>`;

            // Satır sonu kontrolü (Pazar günü ise satırı kapat ve yenisini aç, ancak son gün değilse)
            if ((startDay - 1 + day) % 7 === 0 && day !== lastDay) {
                html += '</tr><tr>';
            }
        }
        
        html += '</tr></tbody></table></div>';
        return html;
    }

    // --- PDF ÇIKTISI ALMA ---
    function exportPDF(elementId, fileName) {
        const element = document.getElementById(elementId);
        const btn = event.currentTarget;
        const oldText = btn.innerHTML;
        
        // Butonu geçici olarak devre dışı bırak
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Hazırlanıyor...';
        btn.disabled = true;

        // Sayfa kaydırmayı en üste al (render hatası olmaması için)
        window.scrollTo(0,0);

        const { jsPDF } = window.jspdf;

        html2canvas(element, {
            scale: 2, // Yüksek çözünürlük
            useCORS: true,
            logging: false,
            backgroundColor: "#ffffff"
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = 210;
            const pdfHeight = 297;
            const margin = 10;
            const imgWidth = pdfWidth - (margin * 2);
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = margin;
            let pageHeight = pdfHeight - (margin * 2);

            // İlk sayfa
            pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            // Eğer içerik tek sayfaya sığmıyorsa yeni sayfalar ekle
            while (heightLeft > 0) {
                position = heightLeft - imgHeight + margin; // Pozisyon ayarlaması
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', margin, - (imgHeight - heightLeft) - margin , imgWidth, imgHeight); // Kaydırma mantığı
                heightLeft -= pageHeight;
            }

            pdf.save(fileName + '_' + new Date().toISOString().slice(0,10) + '.pdf');
            
            // Butonu eski haline getir
            btn.innerHTML = oldText;
            btn.disabled = false;
        }).catch(err => {
            console.error(err);
            alert("PDF oluşturulurken bir hata oluştu.");
            btn.innerHTML = oldText;
            btn.disabled = false;
        });
    }
</script>

</body>
</html>
